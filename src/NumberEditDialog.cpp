//
//  Copyright (c) 2023, Alexander Hude
//  All rights reserved.
//

#include "Inkplate.h"
#include "Fonts/FreeSansBold18pt7b.h"

#include "EventManagerDelegate.hpp"
#include "NumberEditDialog.hpp"

#include "helper.hpp"

const unsigned char NumberEditDialog::s_okIcon [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x30, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x10, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x10, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x10, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x10, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x30, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x70, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x01, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x03, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x07, 0xf0, 
	0xf9, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x0f, 0xf0, 0xc0, 0x7f, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0xf0, 
	0x80, 0x3f, 0xff, 0xff, 0xc0, 0x00, 0x3f, 0xf0, 0x80, 0x1f, 0xff, 0xff, 0x80, 0x00, 0x7f, 0xf0, 
	0x00, 0x0f, 0xff, 0xff, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x01, 0xff, 0xf0, 
	0x00, 0x03, 0xff, 0xfc, 0x00, 0x03, 0xff, 0xf0, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x07, 0xff, 0xf0, 
	0x80, 0x00, 0xff, 0xf0, 0x00, 0x0f, 0xff, 0xf0, 0x80, 0x00, 0x7f, 0xe0, 0x00, 0x1f, 0xff, 0xf0, 
	0xc0, 0x00, 0x3f, 0xc0, 0x00, 0x3f, 0xff, 0xf0, 0xe0, 0x00, 0x1f, 0x80, 0x00, 0x7f, 0xff, 0xf0, 
	0xf0, 0x00, 0x0f, 0x00, 0x00, 0xff, 0xff, 0xf0, 0xf8, 0x00, 0x06, 0x00, 0x01, 0xff, 0xff, 0xf0, 
	0xfc, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xf0, 0xfe, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xf0, 
	0xff, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0xff, 0x80, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xf0, 
	0xff, 0xc0, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xf0, 0xff, 0xe0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xf0, 
	0xff, 0xf0, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xf8, 0x00, 0x01, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xfc, 0x00, 0x03, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xfe, 0x00, 0x07, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0x80, 0x1f, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0
};

const unsigned char NumberEditDialog::s_cancelIcon [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf0, 
	0xfe, 0x03, 0xff, 0xff, 0xff, 0xfc, 0x07, 0xf0, 0xfc, 0x01, 0xff, 0xff, 0xff, 0xf8, 0x03, 0xf0, 
	0xfc, 0x00, 0xff, 0xff, 0xff, 0xf0, 0x03, 0xf0, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0xe0, 0x01, 0xf0, 
	0xf8, 0x00, 0x3f, 0xff, 0xff, 0xc0, 0x01, 0xf0, 0xf8, 0x00, 0x1f, 0xff, 0xff, 0x80, 0x01, 0xf0, 
	0xf8, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x01, 0xf0, 0xfc, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x03, 0xf0, 
	0xfc, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x03, 0xf0, 0xfe, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x07, 0xf0, 
	0xff, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x0f, 0xf0, 0xff, 0x80, 0x00, 0x7f, 0xe0, 0x00, 0x1f, 0xf0, 
	0xff, 0xc0, 0x00, 0x3f, 0xc0, 0x00, 0x3f, 0xf0, 0xff, 0xe0, 0x00, 0x1f, 0x80, 0x00, 0x7f, 0xf0, 
	0xff, 0xf0, 0x00, 0x0f, 0x00, 0x00, 0xff, 0xf0, 0xff, 0xf8, 0x00, 0x06, 0x00, 0x01, 0xff, 0xf0, 
	0xff, 0xfc, 0x00, 0x00, 0x00, 0x03, 0xff, 0xf0, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 
	0xff, 0xff, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xf0, 0xff, 0xff, 0x80, 0x00, 0x00, 0x1f, 0xff, 0xf0, 
	0xff, 0xff, 0xc0, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x7f, 0xff, 0xf0, 
	0xff, 0xff, 0xf0, 0x00, 0x00, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xf8, 0x00, 0x01, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xfc, 0x00, 0x03, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xf8, 0x00, 0x01, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xf0, 0x00, 0x00, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x7f, 0xff, 0xf0, 
	0xff, 0xff, 0xc0, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0xff, 0xff, 0x80, 0x00, 0x00, 0x1f, 0xff, 0xf0, 
	0xff, 0xff, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xf0, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 
	0xff, 0xfc, 0x00, 0x00, 0x00, 0x03, 0xff, 0xf0, 0xff, 0xf8, 0x00, 0x06, 0x00, 0x01, 0xff, 0xf0, 
	0xff, 0xf0, 0x00, 0x0f, 0x00, 0x00, 0xff, 0xf0, 0xff, 0xe0, 0x00, 0x1f, 0x80, 0x00, 0x7f, 0xf0, 
	0xff, 0xc0, 0x00, 0x3f, 0xc0, 0x00, 0x3f, 0xf0, 0xff, 0x80, 0x00, 0x7f, 0xe0, 0x00, 0x1f, 0xf0, 
	0xff, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x0f, 0xf0, 0xfe, 0x00, 0x01, 0xff, 0xf8, 0x00, 0x07, 0xf0, 
	0xfc, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x03, 0xf0, 0xf8, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x01, 0xf0, 
	0xf8, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x01, 0xf0, 0xf8, 0x00, 0x1f, 0xff, 0xff, 0x80, 0x01, 0xf0, 
	0xf8, 0x00, 0x3f, 0xff, 0xff, 0xc0, 0x01, 0xf0, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0xe0, 0x01, 0xf0, 
	0xfc, 0x00, 0xff, 0xff, 0xff, 0xf0, 0x03, 0xf0, 0xfe, 0x01, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xf0, 
	0xff, 0x07, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0
};

void NumberEditDialog::reset() {
    m_number.setText("");
}

void NumberEditDialog::clearBackground(Inkplate* context) {
	context->fillRect(m_headerSplit.getXpos(), m_headerSplit.getYpos(), s_width, s_height, WHITE);
}

char* NumberEditDialog::getText() {
	return m_number.getText();
}

void NumberEditDialog::setHeaderText(const char* title) {
	m_headerText.setText(title);
}

void NumberEditDialog::setTextLimit(int limit) {
    m_number.setTextLimit(limit);
}

void NumberEditDialog::setSecureMode(bool secure) {
	m_number.setSecureMode(secure);
}

void NumberEditDialog::setActions(ActionHandler okAction, ActionHandler cancelAction) {
	m_ok.setAction(okAction);
	m_cancel.setAction(cancelAction);
}

void NumberEditDialog::create(int width, int height) {
    m_headerSplit.setXYpos((width - s_width)/2, (height - s_height)/2);
    m_headerSplit.setArea(s_width, s_height);
    m_headerSplit.setOffset(80);

    int dlgXpos = m_headerSplit.getXpos();
    int dlgYpos = m_headerSplit.getYpos();

    m_headerText.setXYpos(dlgXpos+30, dlgYpos+60);
    m_headerText.setFont(&FreeSansBold18pt7b);

    dlgXpos = m_headerSplit.getXpos()+30;
    dlgYpos = m_headerSplit.getYpos() + m_headerSplit.getTopHeight() + 20;

    m_number.setXYpos(dlgXpos, dlgYpos);
    m_number.setWidth(80 + 30 + 80 + 30 + 80);
    m_number.setHeight(65);

    dlgYpos = m_headerSplit.getYpos() + m_headerSplit.getTopHeight() + 105;

    char digitText[2] = {'1', '\0'};

    for (int d = 1; d < 10; d++) {
        char digit = digitText[0];
        m_digits[d].setXYpos(dlgXpos, dlgYpos);
        m_digits[d].setText(digitText);
        m_digits[d].setAction([digit, this] () {
            m_number.enterCharacter(digit);
        });

        dlgXpos += m_digits[d].getWidth() + 30;
        if ((d % 3) == 0) {
            dlgXpos = m_headerSplit.getXpos() + 30;
            dlgYpos += m_digits[d].getHeight() + 20;
        }

        digitText[0] += 1;
    }
    
    digitText[0] = '0';

    m_ok.setXYpos(dlgXpos, dlgYpos);
    m_ok.setIcon(s_okIcon);

    dlgXpos += m_ok.getWidth() + 30;

    m_digits[0].setXYpos(dlgXpos, dlgYpos);
    m_digits[0].setText(digitText);
    m_digits[0].setAction([this] () {
        m_number.enterCharacter('0');
    });
	
    dlgXpos += m_digits[0].getWidth() + 30;

    m_cancel.setXYpos(dlgXpos, dlgYpos);
    m_cancel.setIcon(s_cancelIcon);
}

bool NumberEditDialog::render(Inkplate* context) {
    int dlgXpos = m_headerSplit.getXpos();
    int dlgYpos = m_headerSplit.getYpos();

	context->drawRect(dlgXpos+1, dlgYpos+1, s_width-2, s_height-2, BLACK);
    context->drawThickLine(dlgXpos + 5, dlgYpos + s_height, dlgXpos + 2 + s_width, dlgYpos + s_height, BLACK, 4);
    context->drawThickLine(dlgXpos + s_width, dlgYpos + 5, dlgXpos + s_width, dlgYpos + 2 + s_height, BLACK, 4);

    m_headerSplit.render(context);
    m_headerText.render(context);

    m_number.render(context);

    for (int d = 1; d < 10; d++) {
        m_digits[d].render(context);
    }
    m_ok.render(context);
    m_digits[0].render(context);
    m_cancel.render(context);

    return false;
}

bool NumberEditDialog::touch(Inkplate* context) {
    bool res = false;
    res |= m_number.touch(context);
    for (int d = 1; d < 10; d++) {
        res |= m_digits[d].touch(context);
    }
    res |= m_ok.touch(context);
    res |= m_digits[0].touch(context);
    res |= m_cancel.touch(context);
    return res;
}
